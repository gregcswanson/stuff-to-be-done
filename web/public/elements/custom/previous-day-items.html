<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="previous-day-items">
  <template>
    <style>
        :host {
            display: block;
        }

        paper-material {
          padding: 10px;
          margin: 10px;
          background: white;
        }

        paper-material p {
          text-align: left;
        }

    </style>

    <!-- items grouped by day -->
    <paper-material elevation="1" hidden$="{{isEmpty}}">
      <template is="dom-repeat" items="{{days}}">
        <p>{{item.Display}}</p>
        <template is="dom-repeat" items="{{item.DayTasks}}">
          <container-element child-name="[[item.ElementName]]" 
              task-id="[[item.TaskID]]"
              show-later=true
              show-today
              is-complete={{item.IsCompleted}}
              is-complete-view={{item.IsCompleted}}
              element-data="[[item.Data]]"
              on-element-updated="_elementUpdated"
              on-element-delete="_elementDelete"
              on-element-do-later="_elementDoLater">
          </container-element>
        </template>
      </template>
    
    </paper-material>

    <!-- ajax calls -->
    <iron-ajax
        id="ajaxGetOpenDays"
        auto
        url="http://localhost:8080/api/v1/book/[[bookId]]/previous/[[dayAsString]]"
        handle-as="json"
        on-response="_ajaxGetOpenDaysResponse"></iron-ajax>
    <iron-ajax
        id="ajaxUpdate"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="PUT"
        url="http://localhost:8080/api/v1/book/[[bookId]]/previous/[[currentTaskId]]"
        handle-as="json"
        on-response="_ajaxUpdateResponse"></iron-ajax>
    <!--<iron-ajax
        id="ajaxDoLater"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="PUT"
        url="http://localhost:8080/api/v1/book/[[bookId]]/previous/[[currentTaskId]]/dolater"
        handle-as="json"
        on-response="_ajaxDoLaterResponse"></iron-ajax> -->
    <iron-ajax
        id="ajaxDelete"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="DELETE"
        url="http://localhost:8080/api/v1/book/[[bookId]]/previous/[[currentTaskId]]/[[currentDayAsString]]"
        handle-as="json"
        on-response="_ajaxDeleteResponse"></iron-ajax>

      <app-api id="appApi" book-id="[[bookId]]" 
          on-task-deleted="_taskDeleted"
          on-task-do-later-completed="_taskDoLaterCompleted"></app-api>
    
  </template>
  <script>
    Polymer({
      is: 'previous-day-items',
      properties: {
        dayAsString: {
          type: String,
          value: '',
        },
        bookId: {
          type: String,
          value: '',
        },
        days: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        isEmpty: {
          type: Boolean,
          value: true
        },
      },
      observers: [
        'daysAddedOrRemoved(days.splices)'
      ],
      daysAddedOrRemoved: function(changeRecord){
        console.log('daysAddedOrRemoved',changeRecord, this.days.length);
        this.isEmpty = this.days.length == 0;
      },
      _ajaxGetOpenDaysResponse: function(data) {
        this.days = data.detail.response.data;
      },
      _elementUpdated: function(ev) {
          var data = ev.detail;
          this.currentTaskId = data.taskId;
          var self = this;
          this.findDayItem(data.taskId, function(day, item){
            self.$.ajaxUpdate.body = { DayID: item.DayID,  TaskID: data.taskId, Data: data.elementData, IsCompleted: data.isCompleted };
            self.$.ajaxUpdate.generateRequest();
          });
      },
      _ajaxUpdateResponse: function(data) {
          var result = data.detail.response.data;
          var self = this;
          this.findDayItem(result.TaskID, function(day, item, index, dayIndex){
            console.log('updated', day, item, index);
            if (result.IsActioned || result.IsCompleted){
              self.removeItem(day, item, index, dayIndex, self);
            }
          });
      },
      removeItem: function(day, item, index, dayIndex, self){
        var newDays = [];
        for(var i = 0; i < day.DayTasks.length; i++)
        {
          if (i != index){
            newDays.push(day.DayTasks[i]);
          }
        }
        if (newDays.length == 0){
          self.splice("days", dayIndex, 1);
        } else {
          self.set("days." + dayIndex + ".DayTasks", newDays);
        }
      },
      findDayItem: function(taskId, callback){
        for(var i  = 0; i < this.days.length; i++){
          var day = this.days[i];
          for(var j  = 0; j < day.DayTasks.length; j++){
            var item = day.DayTasks[j];
            if (item.TaskID == taskId){
              callback(day, item, j, i);
              return;
            }
          }
        }
      },
      
      /*_XelementDoLater: function(ev){
          var data = ev.detail;
          this.currentTaskId = data.taskId;
          var self = this;
          this.findDayItem(data.taskId, function(day, item){
            self.$.ajaxDoLater.body = { DayID: item.DayID,  TaskID: data.taskId, Data: data.elementData, IsCompleted: data.isCompleted };
            self.$.ajaxDoLater.generateRequest();
          });
      },
      _ajaxDoLaterResponse: function(data) {
          var result = data.detail.response.data;
          var self = this;
          this.findDayItem(result.TaskID, function(day, item, index, dayIndex){
            console.log('do later', day, item, index);
            self.removeItem(day, item, index, dayIndex, self);
          });
      },*/

      _elementDoLater: function(ev){
          var data = ev.detail;
          data.dayId = '';
          console.log('container element do later', data);
          this.$.appApi.doTaskLater(data);
      },
      _taskDoLaterCompleted: function(ev){
          var data = ev.detail.item;
          console.log('_taskDoLaterCompleted', data);
          var self = this;
          this.findDayItem(data.TaskID, function(day, item, index, dayIndex){
            console.log('do later', day, item, index);
            self.removeItem(day, item, index, dayIndex, self);
          });
          //var item = this.items.find(function(f){return f.ID == taskID});
          //if (item && !data.IsCompleted) {
          //  var index = this.items.indexOf(item);
          //  this.splice('items', index, 1);
          //}
      },


      _elementDelete: function(ev) {
          var data = ev.detail;
          this.$.appApi.deleteTask(data.taskId);
      },
      _taskDeleted: function(event){
          var data = event.detail.item;
          console.log('_taskDeleted', data);
          var taskID = data.TaskID;
          var self = this;
          this.findDayItem(taskID, function(day, item, index, dayIndex){
            console.log('deleted', day, item, index);
            self.removeItem(day, item, index, dayIndex, self);
          });
      },
      /*_ajaxDeleteResponse: function(data) {
          var result = data.detail.response.data;
          var self = this;
          this.findDayItem(result.TaskID, function(day, item, index, dayIndex){
            console.log('deleted', day, item, index);
            self.removeItem(day, item, index, dayIndex, self);
          });
      },
      
      _ajaxCreateDayItemPostResponse: function(data) {
          console.log(data.detail.response.data);
          // check for error codes?
          this.push('items', data.detail.response.data);
      },
      
      _ajaxDoLaterResponse: function(data) {
          var result = data.detail.response.data;
          console.log('_ajaxDoLaterResponse', result);
          var item = this.items.find(function(f){return f.TaskID == result.TaskID});
          console.log('unshift item', item);
          if (item) {
            var index = this.items.indexOf(item);
            this.splice('items', index, 1);
          }
          // trigger an update message to the later module if it exists
      },
      _ajaxDeleteDayItem: function(data) {
          console.log('_ajaxDeleteDayItem', data.detail.response.data);
          var taskID = data.detail.response.data.ID;
          this.undoDeleteTaskId = taskID;
          var item = this.items.find(function(f){return f.ID == taskID});
          console.log('unshift item', item);
          if (item) {
            var index = this.items.indexOf(item);
            this.splice('items', index, 1);
          }
      },
      _laterRestoreResponse: function(data) {
        this.$.laterGet.generateRequest();
        this.undoDeleteTaskId = "";
      },
      
      */
    });
  </script>
</dom-module>
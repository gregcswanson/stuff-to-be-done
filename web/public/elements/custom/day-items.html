<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="day-items">
  <template>
    <style>
        :host {
            display: block;
        }

        paper-material {
          padding: 10px;
          margin: 10px;
          background: white;
        }

        paper-material.no-items p {
          text-align: center;
        }

        add-element {
          display: block;
          position: fixed;
          bottom: 10px;
          right: 10px;
          z-index: 1;
        }

    </style>
    <!-- items -->
    <paper-material elevation="1" hidden$="{{isEmpty}}">
      <p>[[dayAsString]]</p>
      <template is="dom-repeat" items="{{items}}">
        <container-element child-name="[[item.ElementName]]" 
            task-id="[[item.TaskID]]"
            is-completed="[[item.IsCompleted]]" 
            show-later=[[!item.IsCompleted]]
            can-reopen=[[item.CanReopen]]
            is-completed-view={{item.IsCompleted}}
            element-data="[[item.Data]]"
            on-element-updated="_elementUpdated"
            on-element-delete="_elementDelete"
            on-element-do-later="_elementDoLater">
        </container-element>
      </template>
    </paper-material>

    <paper-material class="no-items" elevation="1" hidden$="{{!isEmpty}}">
      <p>No items today</p>
    </paper-material>

    <!-- action button -->
    <add-element book-id="[[bookId]]" on-add-selected-element="_addElement"></add-element>
    <!-- undo button -->
    <template is="dom-if" if="{{undoDeleteTaskId}}">
      <paper-button on-tap="_restoreItem">
        Undo last delete
      </paper-button>
    </template>
    <!-- ajax calls -->
    <iron-ajax
        id="ajaxGetDayItems"
        url="http://localhost:8080/api/v1/book/[[bookId]]/day/[[dayAsString]]"
        handle-as="json"
        on-response="_ajaxGetDayItemsResponse"></iron-ajax>

    <iron-ajax
        id="ajaxCreateDayItem"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="POST"
        url="http://localhost:8080/api/v1/book/[[bookId]]/day/[[dayAsString]]"
        handle-as="json"
        on-response="_ajaxCreateDayItemPostResponse"></iron-ajax>
    <iron-ajax
        id="ajaxUpdateDayItem"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="PUT"
        url="http://localhost:8080/api/v1/book/[[bookId]]/day/[[currentTaskId]]"
        handle-as="json"
        on-response="_ajaxUpdateDayItemResponse"></iron-ajax>
    <iron-ajax
        id="ajaxDoLaterDayItem"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="PUT"
        url="http://localhost:8080/api/v1/book/[[bookId]]/dolater/[[currentTaskId]]"
        handle-as="json"
        on-response="_ajaxDoLaterResponse"></iron-ajax>
    <iron-ajax
        id="laterRestore"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="PUT"
        url="http://localhost:8080/api/v1/book/[[bookId]]/later/[[currentTaskId]]/restore"
        handle-as="json"
        on-response="_laterRestoreResponse"></iron-ajax>
    
      <app-api id="appApi" book-id="[[bookId]]" 
          on-task-deleted="_taskDeleted"></app-api>
  </template>
  <script>
    Polymer({
      is: 'day-items',
      properties: {
        dayAsString: {
          type: String,
          value: '',
          observer: '_onDayAsStringChanged',
        },
        bookId: {
          type: String,
          value: '',
        },
        currentTaskId: {
          type: String,
          value: '',
        },
        undoDeleteTaskId: {
          type: String,
          value: '',
        },
        items: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        isEmpty: {
          type: Boolean,
          value: true
        },
      },
      observers: [
        'itemsAddedOrRemoved(items.splices)'
      ],
      _onDayAsStringChanged: function(newValue){
        if (newValue !== ''){
          this.$.ajaxGetDayItems.generateRequest();
        }
      },
      /*ready: function(){
        if (this.dayAsString !== '') {
          this.$.ajaxGetDayItems.generateRequest();
        }
      },*/
      itemsAddedOrRemoved: function(changeRecord){
        console.log('itemsAddedOrRemoved',changeRecord, this.items.length);
        this.isEmpty = this.items.length == 0;
      },
      _addElement: function(ev){
         var item = ev.detail.item;
          console.log('_addElement', item);
          // ajax request to create default object
          this.$.ajaxCreateDayItem.body = { elementName: item.ElementName };
          this.$.ajaxCreateDayItem.generateRequest();
      },
      _elementDoLater: function(ev){
          var data = ev.detail;
          console.log('container element do later', data);
          this.currentTaskId = data.taskId;
          // find the dayId from the current list
          var item = this.items.find(function(f){return f.TaskID == data.taskId});
          if (item != null){
            this.$.ajaxDoLaterDayItem.body = { DayID: item.DayID,  TaskID: data.taskId, Data: data.elementData, IsCompleted: data.isCompleted };
            this.$.ajaxDoLaterDayItem.generateRequest();
          }
      },
      _restoreItem: function() {
          this.currentTaskId = this.undoDeleteTaskId;
          this.$.laterRestore.body = { ID: this.undoDeleteTaskId };
          this.$.laterRestore.generateRequest();
      },
      _ajaxGetDayItemsResponse: function(data) {
        this.items = data.detail.response.data;
      },
      _ajaxCreateDayItemPostResponse: function(data) {
          console.log(data.detail.response.data);
          // check for error codes?
          this.push('items', data.detail.response.data);
      },
      _ajaxUpdateDayItemResponse: function(data) {
          var result = data.detail.response.data;
          //console.log('_ajaxUpdateDayItemResponse', data.detail.response.data);
          var item = this.items.find(function(f){return f.TaskID == result.TaskID});
          //console.log('refresh item', item);
          if (item) {
            var index = this.items.indexOf(item);
            
            console.log('refresh item', index, result);
            this.splice('items', index, 1, result);
            //this.set('items', this.items);
            //this.push('items', result);
            //this.items[index] = result;
            //this.$.ajaxGetDayItems.generateRequest();
          }
      },
      _ajaxDoLaterResponse: function(data) {
          var result = data.detail.response.data;
          console.log('_ajaxDoLaterResponse', result);
          var item = this.items.find(function(f){return f.TaskID == result.TaskID});
          console.log('unshift item', item);
          if (item) {
            var index = this.items.indexOf(item);
            this.splice('items', index, 1);
          }
          // trigger an update message to the later module if it exists
      },
      
      _taskDeleted: function(event){
          var data = event.detail.item;
          console.log('_taskDeleted', data);
          var taskID = data.TaskID;
          var self = this;
          var item = this.items.find(function(f){return f.TaskID == taskID});
          if (item) {
            var index = this.items.indexOf(item);
            console.log('remove item', item, index);
            this.splice('items', index, 1);
          }
      },
      _laterRestoreResponse: function(data) {
        this.$.laterGet.generateRequest();
        this.undoDeleteTaskId = "";
      },
      _elementUpdated: function(ev) {
          console.log(ev);
          var data = ev.detail;
          console.log('container element data updated', data);
          this.currentTaskId = data.taskId;
          // find the dayId from the current list
          var item = this.items.find(function(f){return f.TaskID == data.taskId});
          if (item != null){
            this.$.ajaxUpdateDayItem.body = { DayID: item.DayID,  TaskID: data.taskId, Data: data.elementData, IsCompleted: data.isCompleted };
            this.$.ajaxUpdateDayItem.generateRequest();
          }
          
      },
      removeItem: function(day, item, index, dayIndex, self){
        var newDays = [];
        for(var i = 0; i < day.DayTasks.length; i++)
        {
          if (i != index){
            newDays.push(day.DayTasks[i]);
          }
        }
        if (newDays.length == 0){
          self.splice("items", dayIndex, 1);
        } else {
          self.set("items." + dayIndex + ".DayTasks", newDays);
        }
      },
      findDayItem: function(taskId, callback){
        for(var i  = 0; i < this.days.length; i++){
          var day = this.days[i];
          for(var j  = 0; j < day.DayTasks.length; j++){
            var item = day.DayTasks[j];
            if (item.TaskID == taskId){
              callback(day, item, j, i);
              return;
            }
          }
        }
      },
      //_elementDelete: function(ev) {
      //    var data = ev.detail;
      //    console.log('container element data delete', data);
      //    this.currentTaskId = data.taskId;
      //    this.$.ajaxDeleteDayItem.generateRequest();
      //},
      _elementDelete: function(ev) {
          var data = ev.detail;
          this.$.appApi.deleteTask(data.taskId);
      },
    });
  </script>
</dom-module>
<link rel="import" href="../../bower_components/polymer/polymer.html">
<dom-module id="complete-items">
  <template>
    <style>
        :host {
            display: block;
        }

        paper-material.no-items {
          padding: 10px;
          margin: 10px;
          background: white;
        }

        paper-material.no-items p {
          text-align: center;
        }

        add-element {
          display: block;
          position: absolute;
          bottom: 10px;
          right: 10px;
        }

    </style>

    <!-- items -->
    <template is="dom-repeat" items="{{items}}">
      <container-element child-name="[[item.ElementName]]" 
          task-id="[[item.ID]]"
          is-complete="[[item.IsComplete]]"
          show-later
          is-complete-view=true 
          element-data="[[item.Data]]"
          on-element-do-later="_elementDoLater">
      </container-element>
    </template>

    <paper-material class="no-items" elevation="1" hidden$="{{!isEmpty}}">
      <p>No items</p>
    </paper-material>

    <!-- undo button -->
    <template is="dom-if" if="{{undoDeleteTaskId}}">
      <paper-button on-tap="_restoreItem">
        Undo last delete
      </paper-button>
    </template>
    <!-- ajax calls -->
    <iron-ajax
        id="completeGet"
        auto
        url="http://localhost:8080/api/v1/book/[[bookId]]/complete"
        handle-as="json"
        on-response="_completeResponse">
    </iron-ajax>
    <iron-ajax
        id="ajaxDoLater"
        x-content-type="application/json"
        content-type="application/x-www-form-urlencoded"
        method="PUT"
        url="http://localhost:8080/api/v1/book/[[bookId]]/complete/[[currentTaskId]]/dolater"
        handle-as="json"
        on-response="_ajaxDoLaterResponse">
    </iron-ajax>
  
  </template>
  <script>
    Polymer({
      is: 'complete-items',
      properties: {
        dayAsString: {
          type: String,
          value: '',
        },
        bookId: {
          type: String,
          value: '',
        },
        currentTaskId: {
          type: String,
          value: '',
        },
        undoDeleteTaskId: {
          type: String,
          value: '',
        },
        items: {
          type: Array,
          value: function() {
            return [];
          },
          notify: true
        },
        isEmpty: {
          type: Boolean,
          value: true
        },
      },
      observers: [
        'itemsAddedOrRemoved(items.splices)'
      ],
      itemsAddedOrRemoved: function(changeRecord){
        console.log('itemsAddedOrRemoved',changeRecord, this.items.length);
        this.isEmpty = this.items.length == 0;
      },
      _completeResponse: function(data) {
        this.items = data.detail.response.data;
      },
      _elementDoLater: function(ev){
          var data = ev.detail;
          console.log('container element do later', data);
          this.currentTaskId = data.taskId;
          this.$.ajaxDoLater.body = { ID: data.taskId, Data: data.elementData, IsComplete: data.isComplete };
          this.$.ajaxDoLater.generateRequest();
      },
      _ajaxDoLaterResponse: function(data){
          console.log('_ajaxDoLaterResponse', data.detail.response.data);
          var taskID = data.detail.response.data.ID;
          var item = this.items.find(function(f){return f.ID == taskID});
          //console.log('_ajaxDoLaterResponse remove', item);
          if (item && !data.IsComplete) {
            var index = this.items.indexOf(item);
            this.splice('items', index, 1);
          }
      },
      
    });
  </script>
</dom-module>